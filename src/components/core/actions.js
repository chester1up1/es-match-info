const OpenDotaKey = "api_key=b80eb33d-65a0-4204-b9f4-148240faa263";
const PandaScoreToken =
  "token=oTe9iS80rlZE9lIOJS_Y-I_xOZGjXbpo-I58nKBk9sdqtZGerLg";
const game = `[{"players":[{"account_id":313631459,"name":"emotions","hero_id":0,"team":4},{"account_id":328972005,"name":"Douyu.一条A狗/328108","hero_id":0,"team":2},{"account_id":164962869,"name":"Again","hero_id":44,"team":0},{"account_id":379300476,"name":"RuHub Obs","hero_id":0,"team":2},{"account_id":378029473,"name":"ruhub obs","hero_id":0,"team":2},{"account_id":690740,"name":"@SUNSfanTV","hero_id":0,"team":2},{"account_id":140288368,"name":"Tobi","hero_id":40,"team":0},{"account_id":92601861,"name":"Aramis","hero_id":51,"team":0},{"account_id":190826739,"name":"BOOM","hero_id":97,"team":0},{"account_id":91730177,"name":"Seleri","hero_id":20,"team":0},{"account_id":87487872,"name":"violinUA","hero_id":0,"team":2},{"account_id":126702445,"name":"в память о нашей любви","hero_id":19,"team":1},{"account_id":97332465,"name":"DøubleEspresso","hero_id":0,"team":2},{"account_id":371831769,"name":"Imba OB2","hero_id":0,"team":2},{"account_id":4281729,"name":"syndereN","hero_id":0,"team":2},{"account_id":400709028,"name":"See You Again","hero_id":11,"team":1},{"account_id":96196828,"name":"633","hero_id":36,"team":1},{"account_id":893336540,"name":"jackie Ω","hero_id":0,"team":2},{"account_id":893308155,"name":"StasiX","hero_id":0,"team":2},{"account_id":896537326,"name":"WePlay! md","hero_id":0,"team":2},{"account_id":116881520,"name":"Palantimos","hero_id":54,"team":1},{"account_id":11550182,"name":"VANSKOR","hero_id":121,"team":1}],"radiant_team":{"team_name":"ViKin.gg","team_id":6685591,"team_logo":777359668599802900,"complete":false},"dire_team":{"team_name":"Team Unique","team_id":7820540,"team_logo":1014940317816759400,"complete":true},"lobby_id":26787731502150884,"match_id":5555051246,"spectators":351,"league_id":12245,"league_node_id":304,"stream_delay_s":300,"radiant_series_wins":0,"dire_series_wins":0,"series_type":1,"scoreboard":{"duration":759.5145263671875,"roshan_respawn_timer":0,"radiant":{"score":4,"tower_state":1983,"barracks_state":63,"picks":[{"hero_id":97},{"hero_id":40},{"hero_id":51},{"hero_id":44},{"hero_id":20}],"bans":[{"hero_id":110},{"hero_id":86},{"hero_id":55},{"hero_id":17},{"hero_id":47},{"hero_id":98},{"hero_id":108}],"players":[{"player_slot":0,"account_id":91730177,"hero_id":20,"kills":1,"death":2,"assists":1,"last_hits":10,"denies":1,"gold":456,"level":6,"gold_per_min":197,"xp_per_min":184,"ultimate_state":3,"ultimate_cooldown":0,"item0":0,"item1":214,"item2":34,"item3":42,"item4":188,"item5":0,"respawn_timer":0,"position_x":-3491.77197265625,"position_y":-1192.3692626953125,"net_worth":1921},{"player_slot":1,"account_id":190826739,"hero_id":97,"kills":0,"death":0,"assists":0,"last_hits":139,"denies":1,"gold":1046,"level":11,"gold_per_min":457,"xp_per_min":579,"ultimate_state":3,"ultimate_cooldown":0,"item0":63,"item1":44,"item2":38,"item3":11,"item4":252,"item5":75,"respawn_timer":0,"position_x":-1730.7452392578125,"position_y":-4025.739013671875,"net_worth":5816},{"player_slot":2,"account_id":164962869,"hero_id":44,"kills":0,"death":0,"assists":0,"last_hits":85,"denies":7,"gold":904,"level":10,"gold_per_min":401,"xp_per_min":443,"ultimate_state":3,"ultimate_cooldown":0,"item0":63,"item1":11,"item2":8,"item3":75,"item4":75,"item5":36,"respawn_timer":0,"position_x":-2917.691162109375,"position_y":-2713.912841796875,"net_worth":5594},{"player_slot":3,"account_id":140288368,"hero_id":40,"kills":3,"death":0,"assists":1,"last_hits":86,"denies":13,"gold":956,"level":9,"gold_per_min":429,"xp_per_min":433,"ultimate_state":3,"ultimate_cooldown":0,"item0":73,"item1":79,"item2":180,"item3":36,"item4":265,"item5":0,"respawn_timer":0,"position_x":-2962.632080078125,"position_y":-1522.165771484375,"net_worth":5606},{"player_slot":4,"account_id":92601861,"hero_id":51,"kills":0,"death":1,"assists":4,"last_hits":4,"denies":7,"gold":153,"level":6,"gold_per_min":147,"xp_per_min":209,"ultimate_state":3,"ultimate_cooldown":0,"item0":43,"item1":36,"item2":214,"item3":265,"item4":20,"item5":16,"respawn_timer":0,"position_x":3405.7314453125,"position_y":-3754.75146484375,"net_worth":2123}],"abilities":[{"ability_id":5237,"ability_level":3},{"ability_id":5238,"ability_level":1},{"ability_id":5239,"ability_level":1},{"ability_id":5240,"ability_level":1},{"ability_id":8019,"ability_level":1},{"ability_id":8022,"ability_level":1},{"ability_id":8020,"ability_level":1},{"ability_id":8023,"ability_level":1},{"ability_id":8024,"ability_level":1},{"ability_id":4000,"ability_level":1},{"ability_id":4001,"ability_level":1}]},"dire":{"score":3,"tower_state":2046,"barracks_state":63,"picks":[{"hero_id":19},{"hero_id":54},{"hero_id":121},{"hero_id":11},{"hero_id":36}],"bans":[{"hero_id":69},{"hero_id":85},{"hero_id":10},{"hero_id":70},{"hero_id":95},{"hero_id":58},{"hero_id":38}],"players":[{"player_slot":128,"account_id":11550182,"hero_id":121,"kills":0,"death":1,"assists":1,"last_hits":14,"denies":1,"gold":240,"level":6,"gold_per_min":166,"xp_per_min":197,"ultimate_state":3,"ultimate_cooldown":0,"item0":29,"item1":36,"item2":42,"item3":39,"item4":0,"item5":88,"respawn_timer":0,"position_x":-3346.9775390625,"position_y":720.6312255859375,"net_worth":1940},{"player_slot":129,"account_id":400709028,"hero_id":11,"kills":1,"death":0,"assists":0,"last_hits":130,"denies":22,"gold":621,"level":11,"gold_per_min":476,"xp_per_min":584,"ultimate_state":3,"ultimate_cooldown":0,"item0":48,"item1":41,"item2":244,"item3":36,"item4":216,"item5":75,"respawn_timer":0,"position_x":-84.90199279785156,"position_y":2246.64501953125,"net_worth":6046},{"player_slot":130,"account_id":96196828,"hero_id":36,"kills":1,"death":0,"assists":2,"last_hits":101,"denies":19,"gold":1047,"level":10,"gold_per_min":443,"xp_per_min":445,"ultimate_state":3,"ultimate_cooldown":0,"item0":180,"item1":36,"item2":73,"item3":237,"item4":79,"item5":73,"respawn_timer":0,"position_x":-3253.0068359375,"position_y":582.1062622070312,"net_worth":6052},{"player_slot":131,"account_id":126702445,"hero_id":19,"kills":1,"death":1,"assists":2,"last_hits":13,"denies":1,"gold":1201,"level":6,"gold_per_min":183,"xp_per_min":187,"ultimate_state":0,"ultimate_cooldown":0,"item0":214,"item1":38,"item2":216,"item3":218,"item4":0,"item5":34,"respawn_timer":0,"position_x":-3325.1318359375,"position_y":563.1590576171875,"net_worth":2466},{"player_slot":132,"account_id":116881520,"hero_id":54,"kills":0,"death":2,"assists":0,"last_hits":67,"denies":7,"gold":624,"level":8,"gold_per_min":344,"xp_per_min":345,"ultimate_state":3,"ultimate_cooldown":0,"item0":6,"item1":36,"item2":2,"item3":25,"item4":11,"item5":50,"respawn_timer":0,"position_x":6155.8876953125,"position_y":-5088.94482421875,"net_worth":4709}],"abilities":[{"ability_id":5249,"ability_level":2},{"ability_id":5250,"ability_level":4},{"ability_id":5251,"ability_level":1},{"ability_id":5252,"ability_level":1},{"ability_id":5253,"ability_level":1},{"ability_id":8019,"ability_level":1},{"ability_id":8022,"ability_level":1},{"ability_id":8020,"ability_level":1},{"ability_id":8023,"ability_level":1},{"ability_id":8024,"ability_level":1},{"ability_id":4000,"ability_level":1},{"ability_id":4001,"ability_level":1}]}}}]`;
export const GetPlayer = (id, dispatch) => {
  fetch(`https://api.opendota.com/api/players/${id}?${OpenDotaKey}`)
    .then((res) => res.json())
    .then(
      (result) => {
        if (result) {
          dispatch({
            type: "GET_PLAYER",
            data: {
              rank: result.leaderboard_rank,
              account_id: result.profile.account_id,
            },
          });
        }
      },
      (error) => {
        console.log(error);
      }
    );
};

export const GetHero = (dispatch) => {
  fetch(`https://api.opendota.com/api/heroStats?${OpenDotaKey}`)
    .then((res) => res.json())
    .then(
      (result) => {
        dispatch({ type: "GET_HERO", data: result });
      },
      (error) => {
        console.log(error);
      }
    );
};
export const GetHeroPlayer = (id, account_id) => {
  return async (dispatch) => {
    fetch(`https://api.opendota.com/api/heroStats?${OpenDotaKey}`)
      .then((res) => res.json())
      .then((result) => {
        let data1 = result.filter((item) => item.hero_id == id)[0];
        fetch(
          `https://api.opendota.com/api/players/${account_id}/heroes?${OpenDotaKey}`
        )
          .then((res) => res.json())
          .then((result) => {
            let data2 = result.filter((item) => item.hero_id == id)[0];

            dispatch({ type: "GET_HERO_ONE", data: [data1, data2] });
          });
      });
  };
};
export const GetTeamLogo = (id) => {
  return async (dispatch) => {
    fetch(`https://api.opendota.com/api/teams/${id}?${OpenDotaKey}`)
      .then((res) => res.json())
      .then(
        (result) => {
          dispatch({
            type: "GET_TEAM_LOGO",
            data: result.logo_url,
          });
        },
        (error) => {
          console.log(error);
        }
      );
  };
};
export const GetTeamRadiantLogo_ = (id) => {
  console.log("");
  return async (dispatch) => {
    fetch(`https://api.opendota.com/api/teams/${id}?${OpenDotaKey}`)
      .then((res) => res.json())
      .then(
        (result) => {
          dispatch({
            type: "GET_RADIANT_LOGO",
            data: result.logo_url,
          });
        },
        (error) => {
          console.log(error);
        }
      );
  };
};
export const GetTeamDireLogo_ = (id) => {
  return async (dispatch) => {
    fetch(`https://api.opendota.com/api/teams/${id}?${OpenDotaKey}`)
      .then((res) => res.json())
      .then(
        (result) => {
          dispatch({
            type: "GET_DIRE_LOGO",
            data: result.logo_url,
          });
        },
        (error) => {
          console.log(error);
        }
      );
  };
};
export const GetTeamRadiantLogo = (id, dispatch) => {
  console.log("kkkkkkkkkkkkkkkkkkkkkkkkkk");
  fetch(`https://api.opendota.com/api/teams/${id}?${OpenDotaKey}`)
    .then((res) => res.json())
    .then(
      (result) => {
        dispatch({
          type: "GET_RADIANT_LOGO",
          data: result.logo_url,
        });
      },
      (error) => {
        console.log(error);
      }
    );
};
export const GetTeamDireLogo = (id, dispatch) => {
  fetch(`https://api.opendota.com/api/teams/${id}?${OpenDotaKey}`)
    .then((res) => res.json())
    .then(
      (result) => {
        dispatch({
          type: "GET_DIRE_LOGO",
          data: result.logo_url,
        });
      },
      (error) => {
        console.log(error);
      }
    );
};
export const GetM = () => {
  const proxyurl = "https://cors-anywhere.herokuapp.com/";
  const url =
    "https://api.steampowered.com/IDOTA2Match_570/GetMatchDetails/v1/?match_id=5553279095&key=ADB0251E72A626836EF309C4C9F03D20";
  fetch(proxyurl + url)
    .then((res) => res.json())
    .then(
      (result) => {},
      (error) => {
        console.log(error);
      }
    );
};
export const GetRunningMatch = () => {
  //1470940560442741681
  // const proxyurl = "https://cors-anywhere.herokuapp.com/";
  const proxyurl = "https://secret-ocean-49799.herokuapp.com/";
  const url =
    "https://api.steampowered.com/IDOTA2Match_570/GetLiveLeagueGames/v1/?key=ADB0251E72A626836EF309C4C9F03D20";

  ////////////////////////////RESERV GAME
  // fetch(proxyurl + url)
  //   .then((res) => res.json())
  //   .then((result) => {
  //     let data = result.result.games.filter((item) => item.league_id == 12245);
  //     let json = JSON.stringify(data);
  //     let new_ = JSON.parse(game); //HERE
  //   });

  return async (dispatch) => {
    fetch(proxyurl + url)
      .then((res) => res.json())
      .then(
        (result) => {
          let data = result.result.games.filter(
            (item) => item.league_id == 12245
          );
          if (data.length !== []) {
            let new_data = JSON.parse(game);
            dispatch({
              type: "GET_RUNNING_MATCH",
              data: new_data[0],
            });
            GetTeamRadiantLogo(new_data[0].radiant_team.team_id, dispatch);
            GetTeamDireLogo(new_data[0].dire_team.team_id, dispatch);
            let r_players = new_data[0].players.filter(
              (item) => item.hero_id !== 0 && item.team == 0
            );
            let d_players = new_data[0].players.filter(
              (item) => item.hero_id !== 0 && item.team == 1
            );
            if (r_players !== [] && d_players !== []) {
              GetHero(dispatch);
            }
            r_players.map((item) => {
              GetPlayer(item.account_id, dispatch);
            });
            d_players.map((item) => {
              GetPlayer(item.account_id, dispatch);
            });
          } else {
            dispatch({ type: "GET_RUNNING_MATCH", data: data[0] });
            GetTeamDireLogo(new_data[0].dire_team.team_id, dispatch);
            GetTeamRadiantLogo(new_data[0].radiant_team.team_id, dispatch);
            let r_players = data[0].players.filter(
              (item) => item.hero_id !== 0 && item.team == 0
            );
            let d_players = data[0].players.filter(
              (item) => item.hero_id !== 0 && item.team == 1
            );
            if (r_players !== [] && d_players !== []) {
              GetHero(dispatch);
            }
            r_players.map((item, index) => {
              GetPlayer(item.account_id, dispatch);
            });
            d_players.map((item, index) => {
              GetPlayer(item.account_id, dispatch);
            });
          }
        },

        (error) => {
          console.log(error);
        }
      );
  };
};

export const GetPastMatches = (id_match, id_team_r, id_team_d) => {
  console.log("GetPastMatches");
  return async (dispatch) => {
    fetch(`https://api.opendota.com/api/matches/${id_match}?${OpenDotaKey}`)
      .then((res) => res.json())
      .then((result) => {
        let now_series_id = result.series_id;
        console.log("tyt", result);
        if (result.error !== "Not Found") {
          fetch(
            `https://api.opendota.com/api/teams/${id_team_r}/matches?${OpenDotaKey}`
          )
            .then((res) => res.json())
            .then((result) => {
              let data = result.filter(
                (item) => item.opposing_team_id == id_team_d
              );
              console.log("TYT->", data);
              let new_data = [];
              data.forEach((element) => {
                fetch(
                  `https://api.opendota.com/api/matches/${element.match_id}?${OpenDotaKey}`
                )
                  .then((res) => res.json())
                  .then((result) => {
                    new_data = [...new_data, result];
                    if (data.length === new_data.length) {
                      console.log(new_data);
                      let final = [];
                      let new_new_data = new_data.sort(function (a, b) {
                        return new Date(b.start_time) - new Date(a.start_time);
                      });
                      new_new_data.forEach((el, index_) => {
                        if (el.series_id !== now_series_id) {
                          let index = final.findIndex(
                            (i) => i[0].series_id == el.series_id
                          );
                          if (index == -1) {
                            final = [...final, [el]];
                          } else {
                            final[index] = [...final[index], el];
                          }
                          if (index_ == new_data.length - 1) {
                            dispatch({ type: "GET_PAST_Matches", data: final });
                          }
                        }
                      });
                    }
                  });
              });
            });
        }
      });
  };
};

export const GetInfoPlayer = (id) => {
  return async (dispatch) => {
    fetch(`https://api.opendota.com/api/players/${id}?${OpenDotaKey}`)
      .then((res) => res.json())
      .then((result) => {
        console.log("player", result);
        dispatch({ type: "GET_PLAYER_INFO", data: result });
      });
  };
};
export const GetPlayerHeroInfo = (id) => {
  return async (dispatch) => {
    let data = [];
    fetch(`https://api.opendota.com/api/players/${id}/heroes?${OpenDotaKey}`)
      .then((res) => res.json())
      .then((result) => {
        function sortByAge(arr) {
          arr.sort((a, b) => (a.games < b.games ? 1 : -1));
        }
        sortByAge(result);
        console.log(result);
        for (let i = 0; i < 3; i++) {
          data = [...data, result[i]];
        }
      })
      .then(() => {
        fetch(`https://api.opendota.com/api/heroStats?${OpenDotaKey}`)
          .then((res) => res.json())
          .then((result) => {
            data.forEach((element, index) => {
              data[index] = {
                ...element,
                info: result.filter((item) => item.id == element.hero_id),
              };
            });
            dispatch({ type: "GET_PLAYERS_HERO", data: data });
          });
      });
    fetch(`https://api.opendota.com/api/players/${id}/wl?${OpenDotaKey}`)
      .then((res) => res.json())
      .then((result) => {
        console.log("wl", result);
        let data = {
          win: result.win,
          lose: result.lose,
          win_rate:
            parseInt((result.win / (result.win + result.lose)) * 100 * 100) /
            100,
        };
        dispatch({ type: "GET_PLAYER_GAMES_WL", data: data });
      });
  };
};
export const PlayerRole = (id) => {
  return async (dispatch) => {
    fetch(
      `https://api.opendota.com/api/players/${id}/matches?limit=100&${OpenDotaKey}`
    )
      .then((res) => res.json())
      .then((result) => {
        let role = [];
        let l1 = 0;
        let l2 = 0;
        let l3 = 0;
        result.forEach((item) => {
          fetch(
            `https://api.opendota.com/api/matches/${item.match_id}?${OpenDotaKey}`
          )
            .then((res) => res.json())
            .then((result) => {
              role = [
                ...role,
                result.players.filter((item) => item.account_id == id)[0]
                  .lane_role,
              ];
              if (role.length > 99) {
                role.forEach((element, index) => {
                  if (element == 1) {
                    l1 = l1 + 1;
                  }
                  if (element == 2) {
                    l2 = l2 + 1;
                  }
                  if (element == 3) {
                    l3 = l3 + 1;
                  }

                  if (index == 98) {
                    if (l1 > l2 && l1 > l3) {
                      dispatch({ type: "GET_LANE", data: "ez lane" });
                    }
                    if (l2 > l1 && l2 > l3) {
                      dispatch({ type: "GET_LANE", data: "mid lane" });
                    }
                    if (l3 > l1 && l3 > l2) {
                      dispatch({ type: "GET_LANE", data: "hard lane" });
                    }
                  }
                });
              }
            });
        });
      });
  };
};
//vanskor 11550182
// export const LeagueGet = () => {
//   fetch(`https://api.opendota.com/api/proMatches${OpenDotaKey}`)
//     .then((res) => res.json())
//     .then((result) => {
//       console.log("leagues", result);
//     });
// };
export const GetLastMatches = (id) => {
  return async (dispatch) => {
    fetch(
      `https://api.opendota.com/api/players/${id}/recentMatches?is_radiant=1&${OpenDotaKey}`
    )
      .then((res) => res.json())
      .then((result) => {
        console.log("tyt->", result);
        let data = [];
        result.forEach((element, index) => {
          let hero = "";
          fetch(`https://api.opendota.com/api/heroStats?${OpenDotaKey}`)
            .then((res) => res.json())
            .then((result) => {
              hero = result.filter(
                (item) => item.hero_id == element.hero_id
              )[0];
            })
            .then(() => {
              if (element.player_slot < 5) {
                if (element.radiant_win) {
                  data = [...data, { element, win: true, hero: hero }];
                } else {
                  data = [...data, { element, win: false, hero: hero }];
                }
              } else {
                if (element.radiant_win) {
                  data = [...data, { element, win: false, hero: hero }];
                } else {
                  data = [...data, { element, win: true, hero: hero }];
                }
              }
              if (index == 19) {
                dispatch({ type: "GET_PLAYERS_LAST_Matches", data: data });
              }
            });
        });
      });
  };
};
export const LeagueDataGet = () => {
  fetch(`https://api.pandascore.co/dota2/tournaments?${PandaScoreToken}`)
    .then((res) => res.json())
    .then((result) => {
      console.log("leaguse ------>", result);
      let data = result.filter((item) => item.league_id == 4447);
      console.log("leaguse ~~~~~~~>", data);
    });
};
